# ğŸ“‹ [TICKET-ID: 2026-01-20] - Unified CLI Monorepo with Plugin System (Python + Node)

## References

* uv workspaces concept & config: ([Astral Docs][1])
* uv export â†’ requirements.txt: ([Astral Docs][2])
* Typer entry points: ([Typer Docs][6])

---

## User Requirements

> * Meta repo chá»©a nhiá»u CLI tools theo domain (vÃ­ dá»¥ `nab/`, `common/`, `tinybots/`).
> * Má»—i tool cÃ³ thá»ƒ viáº¿t báº±ng Node.js hoáº·c Python (tuá»³ "nhanh gá»n" hay "cáº§n Python").
> * **Unified CLI**: Táº¥t cáº£ tools Ä‘á»u accessible qua má»™t command duy nháº¥t `aw <subcommand>`.
> * Folder structure theo **domain/project**, **khÃ´ng chia theo ngÃ´n ngá»¯** (táº¥t cáº£ CLI Ä‘á»u náº±m trong `cli/`).
> * Package naming theo **feature** (khÃ´ng prefix `dt-`).
> * Cáº§n "uv config á»Ÿ root tÆ°Æ¡ng tá»± pnpm" Ä‘á»ƒ quáº£n lÃ½ mono repo Python.
> * MÃ¡y cÃ´ng ty bá»‹ cháº·n `uv` â†’ váº«n pháº£i cháº¡y Ä‘Æ°á»£c báº±ng `pip`.
> * Root cÃ³ **`requirements.txt`** dÃ¹ng cho **toÃ n bá»™** Python tools, do `uv` generate ra (pinned + transitive).

---

## ğŸ¯ Objective

> Thiáº¿t káº¿ vÃ  chuáº©n hoÃ¡ má»™t unified CLI monorepo cÃ³ thá»ƒ:
>
> * **Single entry point**: `aw <subcommand>` cho táº¥t cáº£ tools (Python + Node)
> * Python plugins: auto-discover via entry points (`aw.plugins`)
> * Node plugins: load via registry + subprocess wrapper
> * Quáº£n lÃ½ Python báº±ng uv workspace (lock 1 láº§n cho cáº£ repo)
> * Quáº£n lÃ½ Node báº±ng pnpm workspace
> * LuÃ´n cÃ³ "fallback path" cháº¡y Ä‘Æ°á»£c trÃªn mÃ¡y khÃ´ng cÃ³ uv báº±ng `pip install -r requirements.txt`

### ğŸ–¥ï¸ Supported Platforms

> **macOS, Linux** only. Windows is out of scope for this implementation.

### âš ï¸ Key Considerations

> 1. **Single Python environment / single lock**: uv workspace dÃ¹ng **má»™t lockfile chung** cho toÃ n workspace members â†’ Ä‘áº£m báº£o versions nháº¥t quÃ¡n. ([Astral Docs][1])
> 2. **Conflict policy**: Náº¿u 2 tool cáº§n 2 versions incompatible cá»§a cÃ¹ng 1 dependency, cáº£ uv sync vÃ  pip fallback Ä‘á»u sáº½ fail (Ä‘Ã¢y lÃ  "constraint" cá»§a mÃ´ hÃ¬nh 1 env).
> 3. Root `requirements.txt` lÃ  "portable lock artifact" cho mÃ´i trÆ°á»ng khÃ´ng cÃ³ uv, Ä‘Æ°á»£c generate tá»« lock (uv export). ([Astral Docs][2])
> 4. **Dual plugin system**: Python dÃ¹ng entry points (native), Node dÃ¹ng registry file + subprocess.
> 5. Internal deps (workspace members) pháº£i khai bÃ¡o `[tool.uv.sources] ... { workspace = true }` **trong pyproject.toml cá»§a member sá»­ dá»¥ng dependency Ä‘Ã³** (khÃ´ng pháº£i root). ([Astral Docs][4])
> 6. **Unified CLI**: Chá»‰ cáº§n link 1 command `dt` thay vÃ¬ nhiá»u commands riÃªng láº».
> 7. **KhÃ´ng chia folder theo ngÃ´n ngá»¯**: Táº¥t cáº£ CLI tools (Python + Node) Ä‘á»u náº±m trong `<domain>/cli/`, phÃ¢n biá»‡t báº±ng file marker (`pyproject.toml` vs `package.json`).

---

## ğŸ—ï¸ Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    User Terminal                            â”‚
â”‚                         â”‚                                   â”‚
â”‚                    aw <command>                             â”‚
â”‚                         â”‚                                   â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚         â”‚                               â”‚                   â”‚
â”‚         â–¼                               â–¼                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Python Plugins  â”‚           â”‚  Node Plugins   â”‚         â”‚
â”‚  â”‚ (Entry Points)  â”‚           â”‚   (Registry +   â”‚         â”‚
â”‚  â”‚                 â”‚           â”‚   Subprocess)   â”‚         â”‚
â”‚  â”‚ â€¢ (none yet)    â”‚           â”‚                 â”‚         â”‚
â”‚  â”‚   (aw.plugins)  â”‚           â”‚ â€¢ foo           â”‚         â”‚
â”‚  â”‚ â€¢ jira          â”‚           â”‚ â€¢ bar           â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Plugin System Comparison

| Type | Discovery | Execution | Use Case |
|------|-----------|-----------|----------|
| **Python** | Entry points (`aw.plugins`) | Direct import | Complex logic, shared libs |
| **Node** | Registry (`aw-plugins.yaml`) | Subprocess | Fast prototyping, npm ecosystem |

---

## ğŸ”„ Implementation Plan

### Phase 1: Analysis & Preparation

* [x] Analyze detailed requirements â†’ Unified CLI architecture
* [x] Define scope and edge cases
* [x] Implement core structure

---

### Phase 2: Folder Structure (Domain-First, Language-Agnostic)

> **Quan trá»ng**: Táº¥t cáº£ CLI tools Ä‘á»u náº±m trong `<domain>/cli/`, khÃ´ng phÃ¢n biá»‡t Python hay Node.
> PhÃ¢n biá»‡t loáº¡i package báº±ng file marker: `pyproject.toml` (Python) hoáº·c `package.json` (Node).

```
devtools/
â”œâ”€â”€ pyproject.toml                    # uv workspace root
â”œâ”€â”€ pnpm-workspace.yaml               # pnpm workspace root
â”œâ”€â”€ package.json                      # root + "packageManager": "pnpm@9.x.x"
â”œâ”€â”€ aw-plugins.yaml                   # Plugin registry (generated, may not be committed)
â”œâ”€â”€ requirements.txt                  # pip fallback (generated, optional)
â”œâ”€â”€ uv.lock                           # uv lockfile (generated)
â”‚
â”œâ”€â”€ common/                           # Shared/cross-project tools
â”‚   â””â”€â”€ cli/
â”‚       â””â”€â”€ devtool/                  # ROOT CLI - exposes `aw` command (Python)
â”‚           â”œâ”€â”€ pyproject.toml
â”‚           â”œâ”€â”€ ruff.toml
â”‚           â””â”€â”€ aweave/
â”‚               â”œâ”€â”€ __init__.py
â”‚               â””â”€â”€ core/
â”‚                   â”œâ”€â”€ __init__.py
â”‚                   â”œâ”€â”€ main.py
â”‚                   â”œâ”€â”€ python_loader.py
â”‚                   â””â”€â”€ node_loader.py
â”‚
â”œâ”€â”€ nab/                              # NAB project domain
â”‚   â””â”€â”€ cli/
â”‚       â”œâ”€â”€ confluence/               # Python package (currently NOT registered as dt plugin)
â”‚       â”‚   â”œâ”€â”€ pyproject.toml
â”‚       â”‚   â””â”€â”€ nab/
â”‚       â”‚       â””â”€â”€ confluence/
â”‚       â”‚           â”œâ”€â”€ __init__.py
â”‚       â”‚           â””â”€â”€ cli.py
â”‚       â””â”€â”€ foo/                      # Node plugin: aw foo
â”‚           â”œâ”€â”€ package.json
â”‚           â”œâ”€â”€ aw-plugin.yaml
â”‚           â””â”€â”€ src/cli.ts
â”‚
â”œâ”€â”€ tinybots/                         # Tinybots project domain
â”‚   â””â”€â”€ local/                        # Non-CLI stuff (docker, seed, etc.)
â”‚       â”œâ”€â”€ docker-compose.yaml
â”‚       â””â”€â”€ ...
â”‚
â””â”€â”€ scripts/
    â”œâ”€â”€ install-all.sh
    â”œâ”€â”€ generate-registry.py
    â”œâ”€â”€ export-requirements.sh
    â””â”€â”€ doctor.sh
```

---

### Phase 3: Detailed Implementation

#### 3.1 Root CLI (`common/cli/devtool`) âœ…

**`common/cli/devtool/pyproject.toml`**:

```toml
[project]
name = "aweave"
version = "0.1.0"
description = "Unified CLI for development tools"
requires-python = ">=3.12"
dependencies = ["pyyaml>=6.0"]

[project.scripts]
aw = "aweave.core.main:app"

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[tool.hatch.build.targets.wheel]
packages = ["aweave"]
```

**`common/cli/devtool/aweave/core/main.py`**:

```python
import typer
from aweave.core.python_loader import load_python_plugins
from aweave.core.node_loader import load_node_plugins

app = typer.Typer(
    name="aw",
    help="Unified CLI for development tools",
    no_args_is_help=True,
)

@app.command()
def version():
    """Show aw version."""
    from aweave import __version__
    typer.echo(f"aw version {__version__}")

# Load plugins
load_python_plugins(app)
load_node_plugins(app)

if __name__ == "__main__":
    app()
```

#### 3.2 Plugin Registry (`aw-plugins.yaml`) âœ…

Auto-generated by `scripts/generate-registry.py`:

```yaml
# Auto-generated by scripts/generate-registry.py
# Do not edit manually. Run: python scripts/generate-registry.py

plugins:
  # Node plugins (loaded via this registry)
  foo:
    type: node
    bin: nab/cli/foo/dist/cli.js
    path: nab/cli/foo
    description: "Foo build tools"
```

#### 3.3 Python Package (Current State: `nab/cli/confluence`) âœ…

Hiá»‡n táº¡i repo cÃ³ `nab/cli/confluence` lÃ  má»™t Python package, nhÆ°ng **chÆ°a register entry point** nÃªn `aw` sáº½ **khÃ´ng auto-add subcommand** tá»« package nÃ y.

**`nab/cli/confluence/pyproject.toml`**:

```toml
[project]
name = "nab-confluence"
version = "0.1.0"
description = "Metan domain tools"
requires-python = ">=3.12"
dependencies = ["aweave"]

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[tool.hatch.build.targets.wheel]
packages = ["nab"]
```

**`nab/cli/confluence/nab/confluence/cli.py`**:

```python
import typer

app = typer.Typer(help="Metan domain tools")

@app.command()
def sync(
    source: str = typer.Argument(..., help="Data source"),
    dry_run: bool = typer.Option(False, "--dry-run", "-n"),
):
    """Sync metan data from source."""
    typer.echo(f"Syncing from {source}..." + (" (dry run)" if dry_run else ""))

@app.command()
def report(format: str = typer.Option("json", "--format", "-f")):
    """Generate metan report."""
    typer.echo(f"Generating {format} report...")

@app.command()
def status():
    """Show metan system status."""
    typer.echo("Metan Status")
    typer.echo("=" * 40)
    typer.echo("Connection: OK")
```

#### 3.4 Node Plugin Example (`nab/cli/foo`) âœ…

> **Note**: Node plugin cÅ©ng náº±m trong `cli/` folder, khÃ´ng pháº£i `node/` folder.

**`nab/cli/foo/aw-plugin.yaml`** (marker for registry scanner):

```yaml
name: foo
description: Foo build and deployment tools
bin: dist/cli.js
```

**`nab/cli/foo/package.json`**:

```json
{
  "name": "@nab/foo",
  "version": "0.1.0",
  "description": "Foo build and deployment tools",
  "type": "module",
  "bin": {
    "nab-foo": "./dist/cli.js"
  },
  "scripts": {
    "build": "tsc",
    "dev": "tsc --watch"
  },
  "dependencies": {
    "commander": "^12.0.0"
  },
  "devDependencies": {
    "@types/node": "^20.0.0",
    "typescript": "^5.0.0"
  }
}
```

**`nab/cli/foo/src/cli.ts`**:

```typescript
#!/usr/bin/env node
import { Command } from 'commander';

const program = new Command();

program
  .name('foo')
  .description('Foo build and deployment tools')
  .version('0.1.0');

program
  .command('build')
  .description('Build the project')
  .option('-w, --watch', 'Watch mode')
  .action((options) => {
    console.log('Building...', options.watch ? '(watch mode)' : '');
  });

program
  .command('deploy')
  .argument('<env>', 'Target environment')
  .action((env) => {
    console.log(`Deploying to ${env}...`);
  });

program.parse();
```

#### 3.5 Workspace Configs âœ…

**`pyproject.toml`** (root):

```toml
[project]
name = "devtools-workspace"
version = "0.1.0"
description = "Unified development tools monorepo"
requires-python = ">=3.13"
dependencies = ["typer>=0.21.1", "aweave", "nab-confluence"]

[tool.uv.workspace]
members = [
    "common/cli/devtool",
    "nab/cli/confluence",
]

[tool.uv.sources]
aweave = { workspace = true }
nab-confluence = { workspace = true }
```

**`pnpm-workspace.yaml`**:

```yaml
packages:
  - "nab/cli/foo"
```

**`package.json`** (root):

```json
{
  "name": "devtools-workspace",
  "version": "0.1.0",
  "private": true,
  "description": "Unified development tools monorepo",
  "packageManager": "pnpm@9.15.0",
  "scripts": {
    "install:all": "./scripts/install-all.sh",
    "build": "pnpm -r build",
    "generate:registry": "python scripts/generate-registry.py"
  },
  "engines": {
    "node": ">=20.0.0"
  }
}
```

#### 3.6 Scripts âœ…

**`scripts/generate-registry.py`**: Scan workspace cho Python (entry points) vÃ  Node (aw-plugin.yaml) plugins.

**`scripts/install-all.sh`**: One-command setup (uv sync hoáº·c pip fallback + pnpm install + generate registry + link aw).

**`scripts/doctor.sh`**: Check environment (python, pip, uv, node, pnpm).

**`scripts/export-requirements.sh`**: Export requirements.txt tá»« uv.lock.

---

### Phase 4: Developer Workflow & CI

#### 4.1 Daily Developer Workflow

| Scenario | Command |
|----------|---------|
| ThÃªm Python plugin má»›i | Táº¡o `<domain>/cli/<name>/` vá»›i `pyproject.toml` + entry point |
| ThÃªm Node plugin má»›i | Táº¡o `<domain>/cli/<name>/` vá»›i `package.json` + `dt-plugin.yaml` |
| ThÃªm external dependency | `uv add <pkg>` trong member folder â†’ `uv lock` |
| Sau khi thÃªm plugin | `python scripts/generate-registry.py` |
| Thay Ä‘á»•i code | KhÃ´ng cáº§n reinstall (Ä‘Ã£ editable) |
| Pull code tá»« remote | `uv sync` hoáº·c `pip install -r requirements.txt` |

#### 4.2 Usage Examples

```bash
# Unified CLI
aw --help
# Commands:
#   version     Show aw version
#   foo         Foo build tools (Node)   # after generating aw-plugins.yaml and building foo

# Node plugins (transparent subprocess)
aw foo build --watch
aw foo deploy staging

# Node plugins still accessible directly
nab-foo build --watch
```

#### 4.3 Setup Commands

```bash
# First time setup
cd devtools
chmod +x scripts/*.sh scripts/*.py
./scripts/install-all.sh

# Or manual steps:
uv sync                              # Install Python packages
pnpm install && pnpm -r build        # Install & build Node packages
python scripts/generate-registry.py  # Generate plugin registry
```

#### 4.4 CI Workflow

```yaml
# .github/workflows/ci.yml
name: CI
on: [push, pull_request]

jobs:
  test-uv:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync
      - run: uv run python scripts/generate-registry.py
      - run: uv run aw --help
      - run: uv run aw foo --help

  test-pip-fallback:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install via pip fallback
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install -r requirements.txt
          for dir in common/cli/devtool nab/cli/confluence; do
            [ -d "$dir" ] && [ -f "$dir/pyproject.toml" ] && pip install -e "$dir" --no-deps
          done
          python scripts/generate-registry.py
      - name: Verify CLI
        run: |
          source .venv/bin/activate
          aw --help

  test-node:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
      - run: pnpm install
      - run: pnpm -r build
```

---

## ğŸ“Š Summary of Results

### âœ… Completed Achievements

* [x] Architecture design: Unified CLI with dual plugin system
* [x] Folder structure: Domain-first, language-agnostic (all in `cli/`)
* [x] aw: Root CLI vá»›i Python + Node plugin loaders
* [x] Sample Python package: `nab/cli/confluence` (chÆ°a register plugin)
* [x] Sample Node plugin: `nab/cli/foo`
* [x] Workspace configs: `pyproject.toml`, `pnpm-workspace.yaml`, `package.json`
* [x] Scripts: `install-all.sh`, `generate-registry.py`, `doctor.sh`, `export-requirements.sh`

### ğŸš§ Next Steps

* [ ] Run `uv sync` to install and test
* [ ] Run `pnpm install && pnpm -r build` for Node packages
* [ ] Run `python scripts/generate-registry.py` to generate registry
* [ ] Test `aw --help` vÃ  `aw foo --help`

## ğŸš§ Outstanding Issues & Follow-up

### âš ï¸ Issues/Clarifications

* [x] **CLI naming**: `aw` (align vá»›i repo name "aweave", ngáº¯n, dá»… gÃµ)
* [x] **Plugin naming**: Feature-based (khÃ´ng prefix)
* [x] **Node integration**: Registry + subprocess wrapper
* [x] **Folder structure**: Táº¥t cáº£ CLI trong `<domain>/cli/`, khÃ´ng chia `node/` riÃªng
* [x] **Workspace configs**: uv members explicit + pnpm workspace explicit
* [ ] **Test full flow**: Cáº§n cháº¡y thá»­ Ä‘á»ƒ verify

---

[1]: https://docs.astral.sh/uv/concepts/projects/workspaces/ "Using workspaces | uv - Astral Docs"
[2]: https://docs.astral.sh/uv/concepts/projects/export/ "Exporting a lockfile | uv - Astral Docs"
[3]: https://docs.astral.sh/uv/concepts/configuration-files/ "Configuration files | uv - Astral Docs"
[4]: https://docs.astral.sh/uv/concepts/projects/dependencies/ "Managing dependencies | uv - Astral Docs"
[5]: https://github.com/astral-sh/uv/issues/9811 "Building and publishing uv workspace members"
[6]: https://typer.tiangolo.com/tutorial/commands/one-or-multiple/ "Typer Commands"
